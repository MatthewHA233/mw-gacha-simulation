# 版本控制强制重置使用说明

## 功能概述

每次推送更新时，可以通过修改版本号触发所有用户的数据重置。每个用户在新版本中只会重置一次。

## 工作原理

1. **版本检查**：应用启动时自动检查 localStorage 中存储的版本号
2. **版本对比**：与当前代码中的版本号进行对比
3. **自动重置**：如果版本号不匹配，自动清除所有数据并更新版本号
4. **单次触发**：每个版本只重置一次，后续访问不再重置

## 如何使用

### 每次推送时更新版本号

编辑 `src/utils/version.js` 文件：

```javascript
export const APP_VERSION = '5.2.0'  // 修改这里的版本号
```

**版本号格式**：语义化版本（Semantic Versioning）`MAJOR.MINOR.PATCH`

版本号规则：
- **MAJOR（主版本号）**：重大功能更新（不向后兼容），例如新增抽卡类型
- **MINOR（次版本号）**：新功能添加（向后兼容），例如新增UI功能
- **PATCH（修订号）**：Bug修复和小改进

示例：
- `5.1.0` - 第5个主版本，第1个次版本，无修订
- `5.1.1` - 在5.1.0基础上的Bug修复
- `6.0.0` - 重大更新（新的主版本）

### 可选：记录版本历史

可以在 `VERSION_HISTORY` 数组中添加更新记录（仅用于文档）：

```javascript
export const VERSION_HISTORY = [
  {
    version: '5.1.0',
    date: '2025-10-12',
    description: '添加版本控制强制重置功能'
  },
  {
    version: '5.1.1',
    date: '2025-10-12',
    description: 'Bug修复 - 修复XXX问题'
  },
  {
    version: '5.2.0',
    date: '2025-10-13',
    description: '新功能 - 添加XXX功能'
  }
]
```

## 用户体验

### Toast 通知

当用户访问新版本时，会看到一个绿色的 Toast 通知：

```
✓ 版本已更新至 v5.2.0
  已自动重置全部数据
```

- **样式**：绿色背景、白色文字、圆角设计
- **位置**：屏幕顶部居中
- **持续时间**：5秒后自动消失
- **触发时机**：应用加载完成后自动显示

## 重置范围

版本更新会清除以下所有本地存储数据：

1. **所有活动的游戏数据**
   - 货币（筹码、钥匙、授权密钥等）
   - 人民币记录
   - 抽卡历史
   - 已获取物品
   - 抽卡统计

2. **氪金里程碑记录**
   - 已触发的里程碑标记

3. **音乐播放状态**
   - BGM 播放/暂停状态

**版本号本身**会被保留，用于后续版本检查。

## 测试方法

### 方法 1：修改版本号测试（推荐）

1. 修改 `src/utils/version.js` 中的版本号（例如从 `5.1.0` 改为 `5.2.0`）
2. 刷新浏览器页面
3. 观察效果：
   - **Toast 通知**：页面顶部会显示绿色的版本更新通知
   - **控制台日志**（F12 → Console）：
     ```
     版本更新检测: 5.1.0 -> 5.2.0
     执行数据重置...
     数据重置完成
     ```
4. 再次刷新，应显示：
   - **无 Toast 通知**
   - **控制台日志**：`当前版本: 5.2.0（无需重置）`

### 方法 2：手动清除版本号测试

1. 打开浏览器开发者工具（F12）
2. 进入 Application/存储 面板
3. 找到 Local Storage
4. 删除 `mw_gacha_app_version` 键
5. 刷新页面，观察效果：
   - **Toast 通知**：页面顶部会显示版本更新通知
   - **控制台日志**：显示版本更新信息

## 注意事项

1. **版本号递增**：建议每次更新都递增版本号，避免重复
2. **用户体验**：数据重置不可逆，确保必要时才更新版本号
3. **推送前确认**：推送前检查版本号是否已更新
4. **控制台日志**：版本检查会在控制台输出日志，方便调试

## 常见场景

### 场景 1：日常功能更新（不需要重置数据）

**不要修改版本号**，用户数据会保留。

### 场景 2：重大更新（需要重置数据）

**修改版本号**，例如：
- 数据结构变更
- 配置文件格式调整
- 修复严重的数据错误
- 活动更新需要重置

### 场景 3：紧急Bug修复

使用 PATCH 版本号递增：
```javascript
// 当前版本
export const APP_VERSION = '5.1.0'

// 紧急Bug修复
export const APP_VERSION = '5.1.1'

// 再次修复
export const APP_VERSION = '5.1.2'
```

### 场景 4：新增小功能

使用 MINOR 版本号递增：
```javascript
// 当前版本
export const APP_VERSION = '5.1.0'

// 添加新功能（向后兼容）
export const APP_VERSION = '5.2.0'
```

### 场景 5：重大更新（新抽卡类型）

使用 MAJOR 版本号递增：
```javascript
// 当前版本
export const APP_VERSION = '5.2.0'

// 重大功能更新
export const APP_VERSION = '6.0.0'
```

## 技术细节

### 文件结构

```
src/
├── utils/
│   ├── version.js              # 版本配置
│   └── gameStateStorage.js     # 版本检查逻辑
├── main.jsx                    # 应用入口（调用版本检查）
└── App.jsx                     # Toast 通知显示
```

### 工作流程

1. **版本检查**（`main.jsx`）
   - 应用启动时调用 `checkAndResetIfNeeded()`
   - 检查 localStorage 中的版本号

2. **数据重置**（`gameStateStorage.js`）
   - 如果版本不匹配，清除所有数据
   - 设置 sessionStorage 标记

3. **Toast 显示**（`App.jsx`）
   - React 组件挂载后检查 sessionStorage 标记
   - 显示版本更新 Toast 通知
   - 清除标记（确保只显示一次）

### 核心函数

```javascript
// 检查版本并在需要时重置
// 返回: { wasReset: true, newVersion: string, oldVersion: string } 或 null
checkAndResetIfNeeded()

// 获取当前存储的版本号
getStoredVersion()

// 保存版本号
saveVersion(version)
```

### Toast 样式自定义

在 `App.jsx` 中修改 Toast 样式：

```javascript
toast.success('消息内容', {
  duration: 5000,  // 持续时间（毫秒）
  style: {
    background: '#10b981',  // 背景色
    color: '#fff',          // 文字颜色
    fontSize: '16px',       // 字体大小
    padding: '16px 24px'    // 内边距
  }
})
```

## 常见问题

### Q: 如何让所有用户重置数据？
A: 修改 `src/utils/version.js` 中的 `APP_VERSION`，然后推送代码。所有用户访问时会看到 Toast 通知并自动重置。

### Q: 如何避免重置数据？
A: 不要修改 `APP_VERSION`。

### Q: 用户会收到重置通知吗？
A: 会！用户首次访问新版本时，页面顶部会显示绿色的 Toast 通知，告知版本号和数据重置。

### Q: Toast 通知会重复显示吗？
A: 不会。Toast 使用 sessionStorage 标记，确保每个版本只显示一次。

### Q: 如何自定义 Toast 样式？
A: 在 `App.jsx` 的 `toast.success()` 中修改样式参数（背景色、字体大小、持续时间等）。

### Q: 如何查看当前版本号？
A: 打开浏览器控制台，输入：`localStorage.getItem('mw_gacha_app_version')`

### Q: 重置失败怎么办？
A: 检查控制台是否有错误日志。可以手动清除 localStorage 后重试。

---

**最后更新**：2025-10-12
**当前版本**：v5.1.0
**版本格式**：语义化版本（Semantic Versioning）
